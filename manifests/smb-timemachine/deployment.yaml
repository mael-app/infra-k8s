apiVersion: apps/v1
kind: Deployment
metadata:
  name: smb-timemachine
spec:
  replicas: 1
  selector:
    matchLabels:
      app: smb-timemachine
  template:
    metadata:
      labels:
        app: smb-timemachine
    spec:
      containers:
      - name: samba
        image: servercontainers/samba:latest
        ports:
        - containerPort: 139
          name: netbios
          hostPort: 139
        - containerPort: 445
          name: smb
          hostPort: 445
        env:
        - name: TZ
          value: "Europe/Paris"
        - name: MODEL
          value: "MacSamba"
        - name: AVAHI_NAME
          value: "Time Machine"
        - name: SAMBA_CONF_WORKGROUP
          value: "WORKGROUP"
        - name: SAMBA_CONF_SERVER_STRING
          value: "Time Machine Server"
        - name: SAMBA_CONF_MAP_TO_GUEST
          value: "Bad User"
        - name: SAMBA_VOLUME_CONFIG_timemachine
          value: "[timemachine]; path=/data/timemachine; valid users=$(SMB_USER); guest ok=no; read only=no; browseable=yes; writeable=yes; create mask=0600; directory mask=0700; vfs objects=fruit streams_xattr; fruit:time machine=yes; fruit:time machine max size=200G"
        - name: SMB_USER
          valueFrom:
            secretKeyRef:
              name: smb-credentials
              key: username
        - name: SMB_PASS
          valueFrom:
            secretKeyRef:
              name: smb-credentials
              key: password
        - name: ACCOUNT_timemachine
          valueFrom:
            secretKeyRef:
              name: smb-credentials
              key: account
        - name: UID_timemachine
          value: "1000"
        volumeMounts:
        - name: smb-data
          mountPath: /data
        resources:
          requests:
            memory: "256Mi"
            cpu: "100m"
          limits:
            memory: "1Gi"
            cpu: "1"
        securityContext:
          privileged: true
          capabilities:
            add:
            - NET_ADMIN
            - SYS_ADMIN
      volumes:
      - name: smb-data
        persistentVolumeClaim:
          claimName: smb-data
